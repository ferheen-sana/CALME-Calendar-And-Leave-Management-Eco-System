{% extends "layout_manager.html" %}
{% load static %}
{% block content %}

<style>
/* ================= ROOT ================= */
body {
    background: linear-gradient(135deg, #f4f6fb, #eef1f6);
}

/* ================= PAGE ================= */
.calendar-page {
    padding: 24px;
}

/* ================= HEADER ================= */
.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 18px;
}

.page-header h2 {
    font-weight: 800;
    margin-bottom: 2px;
}

.page-header p {
    color: #666;
    font-size: 14px;
}

/* ================= LAYOUT ================= */
.calendar-layout {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 20px;
}

/* ================= CARDS ================= */
.card {
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(14px);
    border-radius: 20px;
    padding: 18px;
    box-shadow: 0 25px 50px rgba(0,0,0,.08);
}

/* ================= CALENDAR ================= */
#calendar {
    min-height: 620px;
}

/* ================= AGENDA ================= */
.agenda h5 {
    font-weight: 700;
    margin-bottom: 12px;
}

.agenda-item {
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 10px;
}

.today {
    background: linear-gradient(135deg,#e3f2ff,#f1f8ff);
    border-left: 4px solid #0d6efd;
    animation: pulse 1.6s infinite;
}

.upcoming {
    background: #fff7e6;
    border-left: 4px solid #ff9800;
}

.completed {
    background: #f1f1f1;
    border-left: 4px solid #999;
    text-decoration: line-through;
}

/* ================= PULSE ================= */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(13,110,253,.3); }
    70% { box-shadow: 0 0 0 14px rgba(13,110,253,0); }
    100% { box-shadow: 0 0 0 0 rgba(13,110,253,0); }
}

/* ================= DRAWER ================= */
.drawer {
    position: fixed;
    top: 0;
    right: -420px;
    width: 400px;
    height: 100%;
    background: #fff;
    box-shadow: -4px 0 20px rgba(0,0,0,.2);
    padding: 20px;
    transition: 0.3s;
    z-index: 9999;
}

.drawer.open {
    right: 0;
}

.drawer h4 {
    font-weight: 700;
    margin-bottom: 12px;
}

.drawer input,
.drawer textarea {
    width: 100%;
    margin-bottom: 10px;
    padding: 8px;
}

/* ================= MOBILE ================= */
@media(max-width: 992px) {
    .calendar-layout {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="calendar-page">

    <!-- HEADER -->
    <div class="page-header">
        <div>
            <h2>ðŸ“… Advanced Calendar</h2>
            <p>Timeline â€¢ Meetings â€¢ Reminders</p>
        </div>

        <button class="btn btn-primary btn-lg" onclick="openDrawer()">
            âž• Add Meeting
        </button>
    </div>

    <!-- CONTENT -->
    <div class="calendar-layout">

        <!-- CALENDAR -->
        <div class="card">
            <div id="calendar"></div>
        </div>

        <!-- AGENDA -->
        <div class="card agenda">
            <h5>Today</h5>
            <div id="agendaList"></div>
        </div>

    </div>
</div>

<!-- ================= DRAWER ================= -->
<div class="drawer" id="drawer">
    <h4 id="drawerTitle">Add Meeting</h4>

    <input type="hidden" id="meetingId">

    <input type="text" id="title" placeholder="Meeting Title">
    <textarea id="description" placeholder="Description"></textarea>
    <input type="datetime-local" id="start">
    <input type="datetime-local" id="end">

    <button class="btn btn-success w-100" onclick="saveMeeting()">Save</button>
    <button class="btn btn-danger w-100 mt-2" id="deleteBtn" onclick="deleteMeeting()" style="display:none;">Delete</button>
    <button class="btn btn-secondary w-100 mt-2" onclick="closeDrawer()">Cancel</button>
</div>

<link href="{% static 'fullcalendar/index.global.min.css' %}" rel="stylesheet">
<script src="{% static 'fullcalendar/index.global.min.js' %}"></script>

<script>
let calendar;
let meetings = {{ meetings_json|safe }};

/* ================= INIT ================= */
document.addEventListener('DOMContentLoaded', function () {

    calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
        initialView: 'timeGridDay',
        height: 'auto',
        nowIndicator: true,
        editable: true,
        selectable: true,
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridDay,timeGridWeek,dayGridMonth'
        },
        events: meetings,

        eventClick(info) {
            openEdit(info.event);
        },

        select(info) {
            openDrawer();
            document.getElementById('start').value = info.startStr.slice(0,16);
            document.getElementById('end').value = info.endStr.slice(0,16);
        },

        eventDrop: autoSave,
        eventResize: autoSave
    });

    calendar.render();
    renderAgenda();
    reminderLoop();
});

/* ================= DRAWER ================= */
function openDrawer() {
    document.getElementById('drawer').classList.add('open');
    document.getElementById('deleteBtn').style.display = "none";
    clearForm();
}

function closeDrawer() {
    document.getElementById('drawer').classList.remove('open');
}

function openEdit(event) {
    openDrawer();
    document.getElementById('drawerTitle').innerText = "Edit Meeting";
    document.getElementById('meetingId').value = event.id;
    document.getElementById('title').value = event.title;
    document.getElementById('start').value = event.startStr.slice(0,16);
    document.getElementById('end').value = event.endStr ? event.endStr.slice(0,16) : '';
    document.getElementById('deleteBtn').style.display = "block";
}

/* ================= ACTIONS ================= */
function saveMeeting() {
    alert("Hook this to your Django POST (add/edit meeting)");
}

function deleteMeeting() {
    const id = document.getElementById('meetingId').value;
    if (!id) return;
    if (confirm("Delete meeting?")) {
        window.location.href = `/manager/calendar/delete/${id}/`;
    }
}

function autoSave(info) {
    console.log("Auto save:", info.event.id);
}

/* ================= AGENDA ================= */
function renderAgenda() {
    const today = new Date().toISOString().split('T')[0];
    const agenda = document.getElementById('agendaList');
    agenda.innerHTML = '';

    meetings.forEach(m => {
        let cls = 'upcoming';
        if (m.start.startsWith(today)) cls = 'today';
        if (m.end && new Date(m.end) < new Date()) cls = 'completed';

        agenda.innerHTML += `
            <div class="agenda-item ${cls}">
                <strong>${m.title}</strong><br>
                ${m.start.replace('T',' ').slice(0,16)}
            </div>`;
    });
}

/* ================= REMINDER ================= */
function reminderLoop() {
    setInterval(() => {
        const now = new Date();
        meetings.forEach(m => {
            const start = new Date(m.start);
            if (Math.abs(start - now) < 60000) {
                alert("ðŸ”” Meeting Reminder: " + m.title);
            }
        });
    }, 30000);
}

function clearForm() {
    document.getElementById('meetingId').value = '';
    document.getElementById('title').value = '';
    document.getElementById('description').value = '';
    document.getElementById('start').value = '';
    document.getElementById('end').value = '';
}
</script>

{% endblock %}

{% extends "layout_manager.html" %}
{% block content %}

<style>
/* ================= WRAPPER ================= */
.history-wrap{
    background:linear-gradient(135deg,#eef2ff,#f8fafc 70%);
    padding:30px;
    border-radius:28px;
}

/* ================= TITLE ================= */
.history-title{
    font-size:26px;
    font-weight:800;
    color:#0f172a;
}
.history-sub{
    font-size:13px;
    color:#64748b;
    margin-bottom:22px;
}

/* ================= SUMMARY ================= */
.summary{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:18px;
    margin-bottom:28px;
}
.summary-card{
    padding:20px;
    border-radius:22px;
    color:white;
    box-shadow:0 15px 35px rgba(0,0,0,.15);
    position:relative;
    overflow:hidden;
}
.summary-card::after{
    content:"";
    position:absolute;
    width:140px;
    height:140px;
    background:rgba(255,255,255,.18);
    border-radius:50%;
    top:-40px;
    right:-40px;
}
.summary-cl{
    background:linear-gradient(135deg,#4f46e5,#6366f1);
}
.summary-rh{
    background:linear-gradient(135deg,#f59e0b,#fbbf24);
}
.summary-title{
    font-size:14px;
    opacity:.9;
}
.summary-value{
    font-size:34px;
    font-weight:800;
    margin-top:6px;
}

/* ================= MONTH SLIDER ================= */
.month-slider{
    display:flex;
    gap:10px;
    overflow-x:auto;
    padding-bottom:8px;
    margin-bottom:20px;
}
.month-slider::-webkit-scrollbar{ display:none; }
.month-btn{
    padding:8px 18px;
    border-radius:18px;
    border:none;
    background:#e5e7eb;
    font-size:13px;
    font-weight:600;
    cursor:pointer;
    white-space:nowrap;
}
.month-btn.active{
    background:#4f46e5;
    color:white;
}

/* ================= FILTERS ================= */
.filters{
    display:grid;
    grid-template-columns:2fr 1fr 1fr auto;
    gap:14px;
    margin-bottom:18px;
}
.filters input,
.filters select{
    border-radius:18px;
}

/* ================= EXPORT ================= */
.export-box{
    display:flex;
    gap:12px;
    margin-top:12px;
}
.export-box a{
    border-radius:18px;
    font-size:13px;
}

/* ================= CARD ================= */
.leave-card{
    background:white;
    border-radius:22px;
    padding:18px;
    margin-bottom:18px;
    box-shadow:0 12px 30px rgba(0,0,0,.08);
    cursor:pointer;
    transition:.3s ease;
}
.leave-card:hover{
    transform:translateY(-5px);
    box-shadow:0 20px 45px rgba(0,0,0,.15);
}

/* ================= EMP ================= */
.emp-row{
    display:flex;
    align-items:center;
    gap:14px;
}
.emp-avatar{
    width:46px;
    height:46px;
    border-radius:50%;
    background:linear-gradient(135deg,#6366f1,#4338ca);
    color:white;
    font-weight:800;
    display:flex;
    align-items:center;
    justify-content:center;
}
.emp-name{
    font-weight:700;
}
.emp-desig{
    font-size:12px;
    color:#64748b;
}

/* ================= META ================= */
.meta{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    font-size:13px;
    margin-top:12px;
    color:#475569;
}

/* ================= BADGES ================= */
.badge{
    padding:6px 14px;
    border-radius:20px;
    font-size:12px;
    font-weight:700;
}
.badge-cl{ background:#eef2ff; color:#4338ca; }
.badge-rh{ background:#fefce8; color:#a16207; }
.status-pending{ background:#fffbeb; color:#b45309; }
.status-approved{ background:#ecfdf5; color:#166534; }
.status-rejected{ background:#fef2f2; color:#991b1b; }

/* ================= EXPAND ================= */
.details{
    max-height:0;
    overflow:hidden;
    transition:.3s ease;
}
.leave-card.active .details{
    max-height:200px;
    margin-top:10px;
}
</style>

<div class="history-wrap">

    <div class="history-title">Employee Leave History</div>
    <div class="history-sub">
        Monthly overview • CL/RH summary • Interactive cards
    </div>

    <!-- SUMMARY -->
    <div class="summary">
        <div class="summary-card summary-cl">
            <div class="summary-title">Total Casual Leaves</div>
            <div class="summary-value">{{ cl_total|default:"0" }}</div>
        </div>
        <div class="summary-card summary-rh">
            <div class="summary-title">Total Restricted Holidays</div>
            <div class="summary-value">{{ rh_total|default:"0" }}</div>
        </div>
    </div>

    <!-- FILTER -->
    <form method="get" class="filters" id="filterForm">
        <input type="text" name="q" placeholder="Search employee"
               value="{{ request.GET.q }}" class="form-control">
        <select name="month" id="monthSelect" class="form-select">
            <option value="">Month</option>
            {% for m in months %}
            <option value="{{ m.0 }}"
                {% if m.0|stringformat:"s" == request.GET.month %}selected{% endif %}>
                {{ m.1 }}
            </option>
            {% endfor %}
        </select>
        <select name="year" class="form-select">
            <option value="">Year</option>
            {% for y in years %}
            <option value="{{ y }}"
                {% if y|stringformat:"s" == request.GET.year %}selected{% endif %}>
                {{ y }}
            </option>
            {% endfor %}
        </select>
        <button class="btn btn-primary">Search</button>
    </form>

    <!-- CARDS -->
    {% for leave in leaves %}
    <div class="leave-card" onclick="this.classList.toggle('active')">

        <!-- EXPORT (✔ FIXED LOCATION) -->
        <div class="export-box">
            <a href="{% url 'leaves:export_manager_excel' %}"
               class="btn btn-success btn-sm">Excel</a>

            <a href="{% url 'leaves:export_manager_pdf' leave.id %}"
               class="btn btn-danger btn-sm">PDF</a>

            <a href="{% url 'leaves:export_manager_word' leave.id %}"
               class="btn btn-secondary btn-sm">Word</a>
        </div>

        <div class="emp-row">
            <div class="emp-avatar">
                {{ leave.user.username|first|upper }}
            </div>
            <div>
                <div class="emp-name">
                    {{ leave.user.get_full_name|default:leave.user.username }}
                </div>
                <div class="emp-desig">
                    {{ leave.user.profile.designation|title }}
                </div>
            </div>
        </div>

        <div class="meta">
            <span>{{ leave.start_date }}</span>
            <span>{{ leave.end_date }}</span>
            <span>{{ leave.total_days }} days</span>
        </div>

        <div style="margin-top:10px;">
            {% if leave.leave_type == "CL" %}
                <span class="badge badge-cl">Casual Leave</span>
            {% else %}
                <span class="badge badge-rh">Restricted Holiday</span>
            {% endif %}

            {% if leave.status == "PENDING" %}
                <span class="badge status-pending">Pending</span>
            {% elif leave.status == "APPROVED" %}
                <span class="badge status-approved">Approved</span>
            {% else %}
                <span class="badge status-rejected">Rejected</span>
            {% endif %}
        </div>

        <div class="details">
            <p><strong>Reason:</strong> {{ leave.reason }}</p>
        </div>
    </div>
    {% empty %}
        <p class="text-muted">No records found</p>
    {% endfor %}

</div>

<script>
function setMonth(m){
    document.getElementById("monthSelect").value = m;
    document.getElementById("filterForm").submit();
}
</script>

{% endblock %}

{% extends "layout.html" %}
{% load static %}
{% block content %}

<style>
.page-title{
    font-size:22px;
    font-weight:700;
    color:#0b3d91;
    margin-bottom:18px;
}

/* NOTIFICATION CARD */
.notify-card{
    background:#ffffff;
    border-radius:14px;
    padding:18px;
    margin-bottom:16px;
    box-shadow:0 10px 22px rgba(0,0,0,.18);
    border-left:6px solid #0b3d91;
    position:relative;
    animation:fadeIn .5s ease;
}
@keyframes fadeIn{
    from{opacity:0; transform:translateY(10px)}
    to{opacity:1}
}

/* NEW TAG */
.new-badge{
    position:absolute;
    top:12px;
    right:12px;
    background:#ef4444;
    color:#fff;
    font-size:11px;
    padding:4px 8px;
    border-radius:12px;
    animation:pulse 1.2s infinite;
}
@keyframes pulse{
    0%{transform:scale(1)}
    50%{transform:scale(1.1)}
    100%{transform:scale(1)}
}

.notify-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.notify-title{
    font-weight:600;
    font-size:16px;
}

.notify-date{
    font-size:12px;
    color:#666;
    margin-top:4px;
}

.notify-body{
    font-size:14px;
    line-height:1.6;
    margin-top:10px;
}

/* STATUS */
.badge-approved{background:#22c55e;color:#fff;padding:5px 10px;border-radius:6px;font-size:12px;}
.badge-rejected{background:#ef4444;color:#fff;padding:5px 10px;border-radius:6px;font-size:12px;}

.print-btn{
    margin-top:10px;
    font-size:13px;
}

/* EMPTY */
.empty-box{
    text-align:center;
    padding:40px;
    background:#fff;
    border-radius:14px;
    box-shadow:0 8px 18px rgba(0,0,0,.15);
}
</style>

<div class="page-title">ðŸ”” Notifications</div>

{% if leaves %}
    {% for leave in leaves %}
    <div class="notify-card notify-item" data-id="{{ leave.id }}">
        {% if not leave.notified %}
        <span class="new-badge">NEW</span>
        {% endif %}

        <div class="notify-header">
            <div class="notify-title">
                Manager {{ leave.status|title }} Your Leave
            </div>

            {% if leave.status == "APPROVED" %}
                <span class="badge-approved">Approved</span>
            {% else %}
                <span class="badge-rejected">Rejected</span>
            {% endif %}
        </div>

        <div class="notify-date">
            {{ leave.applied_on|date:"d M Y" }}
        </div>

        <div class="notify-body">
            Dear <b>{{ request.user.username }}</b>,<br><br>

            Your leave application from
            <b>{{ leave.start_date|date:"d M Y" }}</b> to
            <b>{{ leave.end_date|date:"d M Y" }}</b>
            for <b>{{ leave.total_days }} day(s)</b>
            has been <b>{{ leave.status|lower }}</b>
            by your reporting manager.
        </div>

        <button class="btn btn-outline-primary btn-sm print-btn"
                onclick="printLetter('{{ leave.id }}')">
            ðŸ–¨ Print Letter
        </button>
    </div>
    {% endfor %}
{% else %}
    <div class="empty-box">
        <h5>No Notifications</h5>
        <p>You donâ€™t have any leave updates yet.</p>
    </div>
{% endif %}

<!-- LETTER PRINT TEMPLATE -->
<div id="printArea" style="display:none"></div>

<script>
/* ==============================
   UNREAD + BELL RED DOT
================================*/
let unread = document.querySelectorAll(".notify-item .new-badge").length;

// store unread count
localStorage.setItem("calme_unread", unread);

// ðŸ”´ Bell red dot (layout.html must have id="bellCount")
if(document.getElementById("bellCount")){
    document.getElementById("bellCount").innerText = unread;
    document.getElementById("bellCount").style.display = unread > 0 ? "inline-block" : "none";
}

// Remove NEW badge after page load
setTimeout(()=>{
    document.querySelectorAll(".new-badge").forEach(b=>b.remove());
    localStorage.setItem("calme_unread",0);
    if(document.getElementById("bellCount")){
        document.getElementById("bellCount").style.display="none";
    }
},2000);

/* ==============================
   PRINT LETTER
================================*/
function printLetter(id){
    const card = document.querySelector(`[data-id="${id}"]`);
    const body = card.querySelector(".notify-body").innerHTML;

    document.getElementById("printArea").innerHTML = `
        <div style="font-family:serif;padding:40px">
            <h3 style="text-align:center">LEAVE APPLICATION STATUS</h3>
            <hr><br>
            ${body}
            <br><br>
            <b>Regards,</b><br>
            Manager<br>
            ADA â€“ CALME
            <br><br><br>
            _______________________<br>
            Employee Signature
        </div>
    `;
    window.print();
}
</script>

<script>
/* ==============================
   REAL-TIME POLLING (2 sec)
================================*/
setInterval(()=>{
    fetch("{% url 'leaves:realtime_notifications' %}")
    .then(res=>res.json())
    .then(data=>{
        if(data.count > 0){
            let bell = document.getElementById("bellCount");
            if(bell){
                bell.innerText = data.count;
                bell.style.display = "inline-block";
            }

            // reload page to show new notifications
            if(window.location.pathname === "{% url 'leaves:realtime_notifications' %}"){
                location.reload();
            }
        }
    });
},2000);
</script>

{% endblock %}
